# Map Analyzer - 新機能ガイド

## 🎉 追加された新機能

### 1. 🗺️ インタラクティブ地図検索

ホーム画面の **「地図で検索」カード** (赤色のカード)をタップしてアクセスできます。

#### 📍 使い方

1. **ホーム画面**を開く
2. **「地図で検索」カード**をタップ（赤色、Location iconのカード）
3. 地図画面が開きます

#### 🎯 3つの選択モード

**モード1: 地点+半径**
- 地図上をタップして中心点を選択
- スライダーで半径を調整(100m〜5000m)
- 青い円が表示されます

**モード2: 矩形範囲**
- 地図上を**2回**タップして対角の2点を指定
- 緑色の矩形が表示されます

**モード3: ポリゴン**
- 地図上を**複数回**タップしてカスタムエリアを作成
- 紫色のポリゴンが表示されます
- 各頂点に番号が表示されます

#### 🗺️ 地図操作

- **ズーム**: マウスホイール / ピンチ
- **パン**: ドラッグ
- **クリア**: 右上のクリアボタン

#### 🔍 検索実行

1. エリアを選択後、**「検索実行」ボタン**をタップ
2. 進捗バーで処理状況を確認
3. 検索結果が地図上にオレンジ色のマーカーで表示
4. **「結果: XX件」ボタン**をタップして詳細を表示

---

### 2. 🤖 AI一括分析（バッチ処理）

地図検索の結果から、すべての画像に対してGemini AI分析を実行できます。

#### 📊 ワークフロー

**ステップ1: サンプルプレビュー**
1. 検索結果の詳細画面で **「AI一括分析を実行」ボタン**をタップ
2. 分析プロンプトを入力（またはクイックプロンプトを選択）
3. **「ステップ1: サンプル3枚でプレビュー」ボタン**をタップ
4. 3枚のサンプル画像に対して分析実行
5. 分析結果をプレビュー確認

**ステップ2: 全画像一括分析**
1. サンプル結果を確認後、プロンプトを調整可能
2. **「ステップ2: 全XX件を一括分析」ボタン**をタップ
3. 進捗バーで処理状況を確認
4. 完了後、**「結果をエクスポート」ボタン**でダウンロード

#### 💡 クイックプロンプト

- **🛣️ 道路状況**: 道路の状態を詳細に分析
- **🚸 交通標識**: すべての標識をリスト化
- **🏢 建物・施設**: 建物の種類を特定

#### 💾 エクスポート

- **JSON形式**: GIS解析に最適
- **Excel形式**: スプレッドシートで編集可能
- エクスポートデータには画像情報 + AI分析結果が含まれます

---

### 3. 🌍 OpenStreetMap統合

#### 地図タイル

- **OpenStreetMap (OSM)** を使用
- 無料で商用利用可能
- 高品質な地図データ

#### 地図の特徴

- 世界中の道路、建物、地形データ
- リアルタイム更新
- 複数の言語対応

---

## 🚀 使用例

### 例1: 渋谷駅周辺の道路状況分析

```
1. 「地図で検索」を開く
2. 渋谷駅を中心に1000m円を選択
3. 検索実行 → 約300枚の画像を取得
4. AI一括分析を実行
5. プロンプト: "この画像の道路状況を詳しく説明してください"
6. サンプル3枚で確認
7. 全300枚を一括分析
8. Excel形式でエクスポート
9. GISソフトで分析
```

### 例2: カスタムエリアの交通標識調査

```
1. 「地図で検索」→ ポリゴンモード
2. 調査エリアを囲むようにタップ
3. 検索実行 → 500枚の画像を取得
4. AI一括分析を実行
5. プロンプト: "この画像に写っている交通標識をすべてリストアップ"
6. 全500枚を分析
7. JSON形式でエクスポート
8. プログラムで標識データを集計
```

---

## 🎯 ホーム画面のカード一覧

ホーム画面には4つのメインカードがあります:

1. **🔴 地図で検索** (赤色)
   - インタラクティブ地図で検索エリアを指定
   - 3つの選択モード対応

2. **🔵 テキスト検索** (青色)
   - 座標を直接入力して検索
   - 従来の検索方法

3. **🟣 AI Analysis** (紫色)
   - 単一画像のAI分析
   - カスタムプロンプト対応

4. **🟢 Data Export** (緑色)
   - データエクスポート設定
   - フォーマット選択

---

## 💻 技術仕様

### 使用ライブラリ

```yaml
flutter_map: ^6.1.0        # 地図表示
url_launcher: ^6.2.2       # 外部リンク
latlong2: ^0.9.0          # 座標計算
```

### 地図ソース

- **タイルURL**: https://tile.openstreetmap.org/{z}/{x}/{y}.png
- **ライセンス**: ODbL (Open Database License)
- **帰属表示**: © OpenStreetMap contributors

### パフォーマンス

- **サンプル分析**: 3枚 → 約10秒
- **一括分析**: 100枚 → 約5分（レート制限あり）
- **地図読み込み**: 数秒（ネットワーク速度依存）

---

## 🔧 トラブルシューティング

### 地図が表示されない

**原因**: ネットワーク接続の問題  
**解決**: ブラウザのキャッシュをクリアして再読み込み

### 検索結果が0件

**原因**: 選択エリアにMapillary画像がない  
**解決**: より広い範囲を選択するか、都市部で試す

### AI分析が遅い

**原因**: Gemini APIのレート制限  
**解決**: 
- 10件ごとに2秒の待機時間あり
- 大量データの場合は時間がかかります

### 「地図で検索」カードが見つからない

**解決**: 
1. ブラウザを完全リロード (Ctrl+Shift+R)
2. キャッシュをクリア
3. 最新のURLにアクセス

---

## 📱 ブラウザ対応

### 推奨ブラウザ

- ✅ Google Chrome (最新版)
- ✅ Microsoft Edge (最新版)
- ✅ Firefox (最新版)
- ✅ Safari (最新版)

### モバイル対応

- ✅ スマートフォンでも動作
- ✅ タッチ操作対応
- ⚠️ 画面が小さいためPC推奨

---

## 🔗 アクセスURL

**🌐 最新版アプリ**: https://5060-i6w1gve4ssf8ly2hkqauq-02b9cc79.sandbox.novita.ai

---

## 📞 サポート

質問や問題がある場合:
- **GitHub Issues**: https://github.com/geomatsuyama/Maptag/issues
- **ドキュメント**: README.md を参照

---

**Map Analyzer v1.1.0**  
Updated: 2025-12-08
